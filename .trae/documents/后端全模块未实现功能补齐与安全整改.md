# 后端全模块未实现功能补齐与安全整改

## 目标范围
- 覆盖 carbon-auth / carbon-system / carbon-assets / carbon-trade / carbon-gate / carbon-chainmaker / carbon-mq / carbon-frame 的“占位实现、写死返回、测试残留、硬编码敏感信息、空返回导致语义不清/潜在 NPE”等问题。
- 输出结果以“可用功能补齐 + 安全整改 + 可回归验证”为标准。

## carbon-assets（资产服务）
- **碳信用面板数据**：实现 `GET /carbonCreditAssets/assetsTotal`，按表字段汇总 total/available/frozen/locked 等，统一口径（可按 assetsStatus/transactionStatus 做过滤开关）。
- **项目数据提交相关**：实现
  - `POST /carbonProject/dataSubmissionPageList`：真实分页查询（按项目、时间、状态、关键字等条件）；
  - `GET /carbonProject/dataSubmissionPage/{id}`：返回该项目提交记录/附件列表。
- **硬编码 localhost 链接**：把 `uploadCredential`、`uploadOwnerData` 返回的 URL 从 `localhost:9091` 改为可配置（如读取 `server.publicBaseUrl` 或从网关域名配置拼接）。
- **未实现/空返回组件**：
  - `CarbonMetaregistryDocServiceImpl`：补齐 upload/isDocRegistration（若暂不做，改为返回明确的业务错误码与说明，不抛 UnsupportedOperationException）。
  - `CarbonBlockChainMsgProduce`：对外部链服务不可用时返回统一失败结构，禁止 `return null`；逐步补齐 addCarbonQuotas、queryAssetsTokenList/queryAssetsTokenInfo。
- **空 Mapper XML 与空壳 ServiceImpl**：
  - 对仅用 MyBatis-Plus BaseMapper 的保持不动；
  - 对确实需要复杂查询的补齐 mapper 方法与 SQL，并删除无用 import/空壳代码。

## carbon-trade（交易服务）
- **补齐占位接口**：
  - `POST /carbonTradeQuote/startTrading`：实现状态机变更、校验、持仓冻结/锁定（必要时调用 assets/system）、落库与事件。
  - `POST /carbonTradePrice/intendedTransaction`：实现意向成交生成、价格与数量校验、撮合/合同生成（按现有业务字段）。
- **清理测试接口**：
  - `TestController`：删除或加严格鉴权并迁移到 `src/test`；默认不随生产启动。
  - `httpTest`：移出 main 包或删除，敏感信息改为本地环境变量读取。
- **恢复/实现被注释的 ES 搜索**：若前端依赖，恢复 `CarbonTradeSearchController` 并完成 ES 查询与分页返回。

## carbon-system（系统服务）
- **权限接口占位**：实现 `POST /sysPermission/getPageList` 的真实返回（至少返回当前登录用户菜单/权限列表，或按原注释逻辑恢复）。
- **ok(null) 语义统一**：例如文章 `info/{id}` 不存在时返回 `fail("数据不存在")` 或统一 404 风格业务码。
- **OkHttp SSL 工厂**：避免返回 null；失败时 fallback 到默认信任策略或直接启动失败并给出明确日志。
- **空 Mapper XML**：识别哪些是历史残留（可删）哪些需要补 SQL；对需要的补齐。

## carbon-auth（认证服务）
- **宽松放行策略收敛**：对 `checkPermission` 中“securityData 为空/permissionCodes 为空/白名单”等策略进行配置化与最小权限原则（至少对异常/缺数据不再默认放行）。
- **ok(null) 语义统一**：`getSecurityData` 查不到时返回明确失败信息。

## carbon-gate（网关）
- **鉴权绕过修复**：`permissionCheck==null`、`授权服务不可用` 等分支不再默认放行，改为失败返回或降级到只放行白名单。
- **CORS 收敛**：按前端域名白名单配置 `Access-Control-Allow-Origin`，并修正 `Allow-Credentials` 与 `*` 的组合。
- **配置清理**：
  - docker entryPoint 不再写死 test profile；
  - dev/test 中硬编码 IP/账号密码改为环境变量/配置中心。

## carbon-chainmaker（链服务，安全优先）
- **密钥/证书迁移（最高优先级）**：
  - 将 crypto-config 下私钥证书从仓库移除（或至少从构建产物剔除），改为部署时挂载/密钥管理服务；
  - 旋转已泄露密钥（生成新证书/私钥并更新节点/SDK 配置）；
  - 增加 .gitignore 与安全校验（防止再次提交）。
- **参数占位写死修复**：controller 缺参时直接返回失败，不再写入占位字符串继续执行。
- **配置去硬编码**：sdk_config.yml/链节点地址/归档 dsn 迁移到环境变量或配置中心。

## carbon-mq / carbon-frame
- **清理 main 下测试类**：把 `mqTest` 迁移到 `src/test` 或删除。
- **Feign fallback 统一**：禁止 fallback `return null`（例如 pushArticle），统一返回 `ApiResult.fail("服务不可用")`。

## 验证与回归
- **接口级回归**：为每个修复点补最小的集成测试/冒烟脚本（关键接口：assetsTotal、dataSubmission、startTrading、intendedTransaction、权限校验）。
- **端到端验证**：
  - 前端页面对应功能（资产面板、项目提交、交易流程、权限菜单）逐条验证；
  - 网关跨域与鉴权场景验证。
- **安全检查**：仓库内敏感文件扫描（私钥/口令/secret），确保清理到位。

## 交付物
- 补齐后的后端实现代码（按模块拆分提交的变更集）。
- 一份“配置迁移指南”（哪些配置需要通过环境变量/Nacos 注入）。
- 一份“冒烟验证清单”（用哪些接口/页面确认功能正常）。

如果确认按以上范围执行，我会按优先级：chainmaker 密钥安全 → 资产/交易占位接口 → 网关鉴权/CORS → system/auth 语义与权限，逐个落地并在每个模块完成后做可运行验证。