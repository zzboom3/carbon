## 现状定位（为什么你感觉是写死）

* 短信验证码目前固定为 `123546`，且真正发送短信的代码被注释掉：[SmsServiceImpl.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/src/main/java/com/carbon/auth/service/impl/SmsServiceImpl.java#L79-L98)

* 注册流程后端没有校验短信验证码：前端传了 `code`，但 [LoginServiceImpl.register](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/src/main/java/com/carbon/auth/service/impl/LoginServiceImpl.java#L119-L158) 没有调用 `checkValidateCode`。

* 系统侧“修改手机号验证码/邮箱验证码”接口是桩：直接 `ok(true)`：[SysAccountController.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-system/src/main/java/com/carbon/system/controller/SysAccountController.java#L140-L150)

* 登录目前没有图形验证码字段：后端 `LoginParam` 的 captcha 字段被注释：[LoginParam.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-frame/carbon-common-model/src/main/java/com/carbon/domain/auth/param/LoginParam.java#L36-L42)

## 目标

* 让“短信验证码”真正可用（随机生成、写入 Redis、真实发送、严格校验、一次性消费、限流）。

* 可选：为登录/发送短信前增加“图形验证码”（无需外部服务，防刷更稳）。

## 实施方案 A（推荐先做）：短信验证码全链路修复

1. **carbon-auth：修复短信验证码生成与发送**

   * 将验证码改为随机 6 位（替换固定 `123546`）。

   * 恢复调用 `sendMsg(...)`（Aliyun 短信 SDK 已存在依赖：[carbon-auth/pom.xml](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/pom.xml#L33-L38)）。

   * 统一过期时间（建议 5 分钟），并加“发送频率限制”（如同手机号 60 秒内只允许发一次）。

   * 修正忘记密码目前的过期时间写成了 `60000` 秒的问题。

   * 涉及文件：[SmsServiceImpl.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/src/main/java/com/carbon/auth/service/impl/SmsServiceImpl.java)

2. **carbon-auth：补上注册时的验证码校验**

   * 在 `register(param)` 开头调用 `smsService.checkValidateCode(phone, code, SMS_REGISTER_KEY)`，校验通过才允许创建账号。

   * 涉及文件：[LoginServiceImpl.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/src/main/java/com/carbon/auth/service/impl/LoginServiceImpl.java)

3. **carbon-system：实现“修改手机号/邮箱验证码”而非直接 true**

   * 方案：carbon-system 通过 Feign 调用 carbon-auth 的短信发送/校验（复用一套验证码服务与 Redis Key 规则），并在 `update/phone` 时校验 code。

   * 邮箱：接入 SMTP（Spring Mail）或第三方邮件服务，发送邮箱验证码并写 Redis，然后在绑定时校验。

4. **前端：修复/统一验证码校验规则与交互**

   * 修复正则 bug：`^\d4$` → `^\d{4}$` 或按 6 位改为 `^\d{6}$`：[inputValidate.js](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_front/src/libs/inputValidate.js#L25-L28)

   * 注册/忘记密码页已具备输入 `code`，只需与后端一致（6 位/TTL）。

## 实施方案 B（增强，后做也行）：图形验证码（登录/发送短信前）

1. **carbon-auth：新增图形验证码接口**

   * 新增 `GET /auth/captcha` 返回 `{ captchaId, imageBase64 }`，验证码值写 Redis（2 分钟、一次性）。
2. **登录接口增加 captcha 字段**

   * 解除 `LoginParam` 中 captcha 字段注释，并在登录前校验 captcha。

   * 同步前端登录页加“验证码图片 + 输入框 + 点击刷新”，并在登录请求体中携带 `captchaId + captchaCode`。

## 你需要提供/开通的服务与数据

**短信（阿里云）**

* `aliyun.accesskey-id`、`aliyun.accesskey-secret`（当前占位值在：[application.yml](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-auth/src/main/resources/application.yml#L57-L63)）

* `sms.sign`（短信签名）

* 短信模板 code：

  * 注册验证码模板（现有常量：`SmsConstant.SMS_TEMPLATE_REGISTER`：[SmsConstant.java](file:///d:/desktop/Carbon_manage_system/carbon_official/carbon_back/carbon-frame/carbon-common-model/src/main/java/com/carbon/domain/common/constant/SmsConstant.java#L10-L16)）

  * 忘记密码模板（需要你提供；我会补常量）

  * 修改手机号模板（需要你提供；我会补常量）

**邮箱（可选）**

* SMTP：host/port/username/password/from（或第三方邮件 API 的 key）

## 验证方式

* 后端：新增单测/编译通过；本地调用发送接口检查 Redis 写入与限流；注册/忘记密码/改手机号走完整校验。

* 前端：注册/忘记密码/改手机号流程真实可用；登录（若做图形验证码）能刷新图片并校验。

如果你确认，我会按“方案 A 先落地短信验证码全链路 + 注册校验 + 系统改手机号校验”开始写代码；图形验证码作为第二阶段追加。
